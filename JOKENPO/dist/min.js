const randomInt=(min,max)=>Math.floor(Math.random()*(max-min+1)+min);const getRandomValueFromList=(list)=>list[Math.floor(Math.random()*list.length)];const getPointDistance=(point1,point2)=>Math.sqrt((point1.x-point2.x)**2+(point1.y-point2.y)**2);const movePointTowards=(point,targetPoint,distance,speed)=>{const normalizedDirection={x:(targetPoint.x-point.x)/distance,y:(targetPoint.y-point.y)/distance,};return{x:point.x+normalizedDirection.x*speed,y:point.y+normalizedDirection.y*speed,};};const battleContainer=document.getElementById("battle-container");const battleRect=battleContainer.getBoundingClientRect();const ENTITY_TYPES={ROCK:"rock",PAPER:"paper",SCISSOR:"scissor",WATER:"water",LOG:"log",FIRE:"fire",};const PLAYER_ENTITY=({});const ENTITIES=({[ENTITY_TYPES.ROCK]:{group:ENTITY_TYPES.ROCK,type:ENTITY_TYPES.ROCK,kills:[ENTITY_TYPES.SCISSOR],speed:1,evolution:{minKills:7,evolution:ENTITY_TYPES.WATER},},[ENTITY_TYPES.PAPER]:{group:ENTITY_TYPES.PAPER,type:ENTITY_TYPES.PAPER,kills:[ENTITY_TYPES.ROCK],speed:1,evolution:{minKills:7,evolution:ENTITY_TYPES.LOG},},[ENTITY_TYPES.SCISSOR]:{group:ENTITY_TYPES.SCISSOR,type:ENTITY_TYPES.SCISSOR,kills:[ENTITY_TYPES.PAPER],speed:1,evolution:{minKills:7,evolution:ENTITY_TYPES.FIRE},},[ENTITY_TYPES.WATER]:{group:ENTITY_TYPES.ROCK,type:ENTITY_TYPES.WATER,kills:[ENTITY_TYPES.PAPER,ENTITY_TYPES.SCISSOR,ENTITY_TYPES.FIRE],speed:2,},[ENTITY_TYPES.LOG]:{group:ENTITY_TYPES.PAPER,type:ENTITY_TYPES.LOG,kills:[ENTITY_TYPES.ROCK,ENTITY_TYPES.SCISSOR,ENTITY_TYPES.WATER],speed:2,},[ENTITY_TYPES.FIRE]:{group:ENTITY_TYPES.SCISSOR,type:ENTITY_TYPES.FIRE,kills:[ENTITY_TYPES.ROCK,ENTITY_TYPES.PAPER,ENTITY_TYPES.LOG],speed:2,},});let entitiesList=([]);const getSpawnableTypes=(withEvolutions=false)=>{const spawnableTypes=[ENTITY_TYPES.ROCK,ENTITY_TYPES.PAPER,ENTITY_TYPES.SCISSOR,];if(withEvolutions)spawnableTypes.push(ENTITY_TYPES.WATER,ENTITY_TYPES.LOG,ENTITY_TYPES.FIRE);if(!SHOP_CONFIG.repeatPlayerType){const typeI=spawnableTypes.indexOf(PLAYER_ENTITY.type);if(typeI>-1)spawnableTypes.splice(typeI,1);const groupI=spawnableTypes.indexOf(PLAYER_ENTITY.group);if(groupI>-1)spawnableTypes.splice(groupI,1);}return spawnableTypes;};const createEntitiesBatch=(withEvolutions)=>{const spawnableTypes=getSpawnableTypes(withEvolutions);for(let i=0;i<SHOP_CONFIG.entitiesPerSpawn;i++){entitiesList.push(createEntity(ENTITIES[getRandomValueFromList(spawnableTypes)]));}};const initEntities=()=>{entitiesList=[];const spawnableTypes=getSpawnableTypes();for(let i=0;i<SHOP_CONFIG.initialSpawn;i++){for(let j=0;j<spawnableTypes.length;j++){entitiesList.push(createEntity(ENTITIES[spawnableTypes[j]]));}}};const entitiesTouching=(entityA,entityB)=>{return(((entityA.pointTop.x>=entityB.pointTop.x&&entityA.pointTop.x<=entityB.pointBottom.x)||(entityB.pointTop.x>=entityA.pointTop.x&&entityB.pointTop.x<=entityA.pointBottom.x))&&((entityA.pointTop.y>=entityB.pointTop.y&&entityA.pointTop.y<=entityB.pointBottom.y)||(entityB.pointTop.y>=entityA.pointTop.y&&entityB.pointTop.y<=entityA.pointBottom.y)));};const killEntity=(entity)=>{if(!entity.element)return;removeEntity(entity);entity.element=null;entitiesList.splice(entitiesList.indexOf(entity),1);};const evolveEntity=(entity)=>{if(!entity.evolution)return;if(entity.killCount>=entity.evolution.minKills){let source=ENTITIES[entity.evolution.evolution];if(source){Object.assign(entity,source);setEntityType(entity);}}};const entityKillEntity=(entityA,entityB)=>{killEntity(entityB);entityA.killCount=(entityA.killCount||0)+1;evolveEntity(entityA);if(entityA===PLAYER_ENTITY)SHOP_CONFIG.points+=SHOP_CONFIG.pointsPerKill;};const getClosestTarget=(entity,entities)=>{let minDistance=Infinity;let selectedTarget=(null);entities.forEach((targetEntity)=>{entity.kills.forEach((t)=>{if(targetEntity.type===t){const distance=getPointDistance(entity.pointTop,targetEntity.pointTop);if(distance<minDistance){selectedTarget=targetEntity;minDistance=distance;}}});});return{target:selectedTarget,distance:minDistance};};const checkTouches=()=>{const freshEntities=[...entitiesList];if(PLAYER_ENTITY.element)freshEntities.push(PLAYER_ENTITY);freshEntities.forEach((entityA)=>{if(!entityA.element)return;freshEntities.forEach((entityB)=>{if(!entityB.element)return;if(entityA!==entityB&&entityA.type!==entityB.type&&entitiesTouching(entityA,entityB)){if(entityA.kills.includes(entityB.type))entityKillEntity(entityA,entityB);if(entityB.kills.includes(entityA.type))entityKillEntity(entityB,entityA);}});});};const moveEntities=()=>{checkTouches();const freshEntities=[...entitiesList];if(PLAYER_ENTITY.element)freshEntities.push(PLAYER_ENTITY);entitiesList.forEach((entity)=>{const{target,distance}=getClosestTarget(entity,freshEntities);if(!target)return;setEntityPoint(entity,movePointTowards(entity.pointTop,target.pointTop,distance,(entity.speed*SHOP_CONFIG.allSpeed*entity.size)/20));});};const PLAYER_MOVEMENT={up:false,down:false,left:false,right:false,};const initPlayer=()=>{Object.assign(PLAYER_ENTITY,createEntity(({group:ENTITY_TYPES.SCISSOR,type:ENTITY_TYPES.SCISSOR,kills:[ENTITY_TYPES.PAPER],speed:1,killCount:0,evolution:{minKills:SHOP_CONFIG.killsToEvolve,evolution:ENTITY_TYPES.FIRE,},}),true));PLAYER_ENTITY.element.classList.add("player");};const movePlayer=()=>{if(!PLAYER_ENTITY.element)return;let y=0;let x=0;if(PLAYER_MOVEMENT.up)y-=PLAYER_ENTITY.speed;if(PLAYER_MOVEMENT.down)y+=PLAYER_ENTITY.speed;if(PLAYER_MOVEMENT.left)x-=PLAYER_ENTITY.speed;if(PLAYER_MOVEMENT.right)x+=PLAYER_ENTITY.speed;if(x||y){x*=SHOP_CONFIG.playerSpeed*1.25;y*=SHOP_CONFIG.playerSpeed*1.25;setEntityPoint(PLAYER_ENTITY,{x:PLAYER_ENTITY.pointTop.x+x,y:PLAYER_ENTITY.pointTop.y+y,});}};const getEntitySize=()=>Math.sqrt((battleRect.width*battleRect.height)/SHOP_CONFIG.initialSpawn)/3;const setEntityPoint=(entity,point)=>{entity.element.style.setProperty("--entity-top",`${point.y}px`);entity.element.style.setProperty("--entity-left",`${point.x}px`);entity.pointTop=point;entity.pointBottom={x:point.x+entity.size,y:point.y+entity.size};};const setEntityType=(entity)=>{if(!entity.element)return;entity.element.className=`image`;entity.element.classList.add(entity.type);if(entity===PLAYER_ENTITY)entity.element.classList.add("player");};const getRandomPointForEntity=(entity)=>{let point={x:randomInt(0,battleRect.width-entity.size),y:randomInt(0,battleRect.height-entity.size),};if(PLAYER_ENTITY.element&&entity!==PLAYER_ENTITY&&getPointDistance(PLAYER_ENTITY.pointTop,point)<(PLAYER_ENTITY.size+entity.size)*3)point=getRandomPointForEntity(entity);return point;};const getMiddlePoint=(entitySize)=>{return{x:battleRect.width/2-entitySize/2,y:battleRect.height/2-entitySize/2,};};const createEntity=(baseEntity,onMiddle=false)=>{const entitySize=getEntitySize();const element=document.createElement("div");element.style.setProperty("--entity-size",`${entitySize}px`);battleContainer.appendChild(element);const entity={...baseEntity,element,size:entitySize};setEntityType(entity);setEntityPoint(entity,onMiddle?getMiddlePoint(entitySize):getRandomPointForEntity(entity));return entity;};const removeEntity=(entity)=>{battleContainer.removeChild(entity.element);};const clearArena=()=>{battleContainer.innerHTML="";};const DVD_ENTITY=({kills:[ENTITY_TYPES.ROCK,ENTITY_TYPES.PAPER,ENTITY_TYPES.SCISSOR,ENTITY_TYPES.WATER,ENTITY_TYPES.LOG,ENTITY_TYPES.FIRE,],speed:7,});let dvdList=([]);const dvdColors=["red","blue","green","purple","orange"];const setDvdClass=(dvdEntity)=>{dvdEntity.element.className=`image dvd ${getRandomValueFromList(dvdColors )}`;};const initDvds=()=>{dvdList=[];};const createDvd=()=>{const entitySize=150;const element=document.createElement("div");element.style.setProperty("--entity-size",`${entitySize}px`);battleContainer.appendChild(element);const dvdEntity={...DVD_ENTITY,element,size:entitySize};dvdEntity.speedX=dvdEntity.speedY=dvdEntity.speed;dvdList.push(dvdEntity);setEntityPoint(dvdEntity,getRandomPointForEntity(dvdEntity));setDvdClass(dvdEntity);};const checkDvdTouch=(dvdEntity,freshEntities)=>{freshEntities.forEach((entity)=>{if(!entity.element)return;if(entitiesTouching(dvdEntity,entity)){entityKillEntity(dvdEntity,entity);}});};const moveDvds=()=>{const freshEntities=[...entitiesList];if(PLAYER_ENTITY.element)freshEntities.push(PLAYER_ENTITY);dvdList.forEach((dvdEntity)=>{checkDvdTouch(dvdEntity,freshEntities);const newPoint=({x:dvdEntity.pointTop.x+dvdEntity.speedX,y:dvdEntity.pointTop.y+dvdEntity.speedY,});if(newPoint.x+dvdEntity.size>=battleRect.width||newPoint.x<=0){dvdEntity.speedX*=-1;setDvdClass(dvdEntity);}if(newPoint.y+dvdEntity.size>=battleRect.height||newPoint.y<=0){dvdEntity.speedY*=-1;setDvdClass(dvdEntity);}setEntityPoint(dvdEntity,newPoint);});};const SHOP_CONFIG={points:0,pointsPerSecond:1,pointsPerKill:20,initialSpawn:250,entitiesPerSpawn:50,secondsToSpawn:4,secondsToDvdSpawn:30,secondsToEvolutionSpawn:15,repeatPlayerType:true,allSpeed:2,playerSpeed:2,killsToEvolve:10,shopOptions:3,};const pointsP=document.getElementById("points");const infosPs=document.getElementsByClassName("shop-infos");const shopDialog=(document.getElementById("shop-dialog"));const shopItemsContainer=document.getElementById("shop-items-container");const shopCloseBtn=document.getElementById("shop-close");const showPoints=()=>{pointsP.innerText=`${SHOP_CONFIG.points}`;};const showInfos=()=>{for(let i=0;i<infosPs.length;i++){const info=infosPs[i];info.innerHTML=SHOP_CONFIG[info.id];}};const SHOP_ITEMS=([{title:"More {x}&nbsp;points per second",options:[1,2,3,4,5],valueFn:(option)=>option*30,effect:(option)=>(SHOP_CONFIG.pointsPerSecond+=option),},{title:"More {x}&nbsp;points per kill",options:[10,20,30,40,50],valueFn:(option)=>option*4,effect:(option)=>(SHOP_CONFIG.pointsPerKill+=option),},{title:"More {x}%&nbsp;speed",options:[0.1,0.5,1],valueFn:(option)=>option*100,effect:(option)=>(SHOP_CONFIG.playerSpeed+=option),},{title:"More {x}%&nbsp;overall speed",options:[0.1,0.5,1],valueFn:(option)=>option*100,effect:(option)=>(SHOP_CONFIG.playerSpeed+=option),},{title:"Less {x}&nbsp;kills to evolve",options:[1,2],valueFn:(option)=>option*30,effect:(option,item)=>{SHOP_CONFIG.killsToEvolve-=option;if(SHOP_CONFIG.killsToEvolve<=2)item.deleted=true;},},{title:"Stop repeating player type",value:500,effect:(_,item)=>{SHOP_CONFIG.repeatPlayerType=false;item.deleted=true;},},]);const createShopItem=(item,refreshItems)=>{const itemContainer=document.createElement("div");itemContainer.className="shop-item";const itemTitle=document.createElement("h4");itemTitle.className="shop-item-title";const itemPrice=document.createElement("p");itemPrice.className="shop-item-value";let option=(null);let value=(item.value);if(item.options)option=getRandomValueFromList(item.options);if(item.valueFn)value=item.valueFn(option);item.chosenValue=value;itemTitle.innerHTML=item.title.replaceAll("{x}",`${option}`);itemPrice.innerHTML=`${value}&nbsp;points`;if(SHOP_CONFIG.points>value)itemContainer.onclick=()=>{if(SHOP_CONFIG.points>value&&!item.disabled){SHOP_CONFIG.points-=value;item.effect(option,item);item.disabled=true;showPoints();refreshItems();}};else itemContainer.classList.add("disabled");itemContainer.appendChild(itemTitle);itemContainer.appendChild(itemPrice);return itemContainer;};const openShop=(callback)=>{shopItemsContainer.innerHTML="";const shoptItems=[...SHOP_ITEMS.filter((item)=>!item.deleted)];const selectedItems=([]);const refreshItems=()=>{for(const item of selectedItems){if(item.item.chosenValue>SHOP_CONFIG.points||item.item.disabled)item.div.classList.add("disabled");}};for(let i=0;i<SHOP_CONFIG.shopOptions;i++){const item=getRandomValueFromList(shoptItems);item.disabled=false;shoptItems.splice(shoptItems.indexOf(item),1);const div=createShopItem(item,refreshItems);shopItemsContainer.appendChild(div);selectedItems.push({item,div});}shopDialog.showModal();shopCloseBtn.onclick=()=>{shopDialog.close();callback();};};let battleInterval=(null);const start=()=>{let timePassed=0;clearInterval(battleInterval);clearArena();initPlayer();initEntities();initDvds();showInfos();const pointsMod=20;const spawnMod=20*SHOP_CONFIG.secondsToSpawn;const dvdSpawnMod=20*SHOP_CONFIG.secondsToDvdSpawn;const evolutionSpawnLimit=20*SHOP_CONFIG.secondsToEvolutionSpawn;battleInterval=setInterval(()=>{moveEntities();moveDvds();if(!PLAYER_ENTITY.element){clearInterval(battleInterval);openShop(()=>start());return;}movePlayer();timePassed++;if(timePassed%spawnMod===0)createEntitiesBatch(timePassed>evolutionSpawnLimit);if(timePassed%dvdSpawnMod===0)createDvd();if(timePassed%pointsMod===0)SHOP_CONFIG.points+=SHOP_CONFIG.pointsPerSecond;showPoints();},50);};start();const ARROW_MOVEMENT_MAP={["ArrowUp"]:"up",["ArrowLeft"]:"left",["ArrowDown"]:"down",["ArrowRight"]:"right",};document.onkeydown=(e)=>{e=e||(window.event);if(e.code.startsWith("Arrow")){PLAYER_MOVEMENT[ARROW_MOVEMENT_MAP[e.code]]=true;}};document.onkeyup=(e)=>{e=e||(window.event);if(e.code.startsWith("Arrow")){PLAYER_MOVEMENT[ARROW_MOVEMENT_MAP[e.code]]=false;}};